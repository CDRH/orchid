<%# expects
  - "sort_by" sort value (e.g. "count|desc")
%>
<h1 id="browseBy"><%= t "browse.browse_type", default: "Browse by" %> <%= @browse_facet_info["label"] %></h1>
<nav aria-label="Facets Menu">
  <ul class="nav nav-tabs buffer-bottom">
    <% @page_facets.each_with_index do |(facet_name, facet_info), index| %>
    <% id = facet_name.parameterize(separator: ".") %>
      <li class="<%= active?(facet_name, @browse_facet) %>">
        <% if facet_name == @browse_facet %>
          <%= link_to prefix_path("browse_facet_path", facet: id) do %>
            <%= facet_info["label"] %>
          <% end %>
        <% else %>  
          <%= link_to prefix_path("browse_facet_path", facet: id) do %>
            <%= facet_info["label"] %>
          <% end %>
        <% end %>
      </li>
    <% end %>
  </ul>
</nav>

<div class="btn-group buffer-bottom">
  <button type="button" class="btn btn-default dropdown-toggle"
    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <%= t "browse.sort_by", default: "Sort by" %>: <%= sort_selected_label("facets", sort_by) %>
    <span class="caret"></span>
  </button>

  <ul class="dropdown-menu">
    <% sort_fields_facets.each do |sort_field, label| %>
      <%= render_overridable("items", "sort_dropdown_item", label: label,
        sort_url: prefix_path("browse_facet_path", f: params[:f], facet_sort: sort_field)) %>
    <% end %>
  </ul>
</div>
<% @page_facets.each_with_index do |(facet_name, facet_info), index| %>
  <% id = facet_name.parameterize(separator: ".")  %>

      <%# handling nested bucket aggregations in format ["rdf.predicate[rdf.type#case_role]", "case_roles"] %>
      <%# query will be based on the original facet, the first part %>
      <%# api response will use the aggregation name, the second part %>
      <% original_facet = facet_name %>
      <% facet_name = facet_info["aggregation_name"] if facet_info["aggregation_name"] %>
      

  <% if @res && @res.key?(facet_name) %>
    <div class="browse-results" id="<%= id %>">
      <ul>
        <% @res[facet_name].each do |key, value| %>
          <%# NOTE the below line accommodates Apium v1.0 as well as
              v1.1 when facet responses included more information %>
          <% key, label, num = format_facet_response(key, value) %>
            <% text = create_label(
              facet_label(
                type: facet_name,
                normalized: key,
                label: label
              ),
              t("browse.no_label")
            ) %>
            <li>
              <%= link_to prefix_path(route_path,
                f: ["#{original_facet}|#{key}"]), rel: "nofollow" do %>
                <p class="index_name_col">
                  <span class="index_name"><%= sanitize text %></span><span class="sr-only-clip">, </span>
                  <span class="index_separator"></span>
                </p>
                <p class="index_num"><%= num %><span class="sr-only-clip"><% if (num != 1) %> <%= t("search.results.plural", default: "results") %><% else %> <%= t("search.results.singular", default: "result") %><% end %></span></p>
              <% end %>
            </li>
        <% end %>
      </ul>
    </div>
    <% end %>
  <% end %>