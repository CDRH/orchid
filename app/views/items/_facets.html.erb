<%# iterate through all of the configured facets
    and match them with the incoming solr facet results %>
<%# TODO refactor the top portion of this %>
<% if facets %>
  <% @page_facets.each do |facet_name, info| %>
    <%# handling nested bucket aggregations in format ["rdf.predicate[rdf.type#case_role]", "case_roles"] %>
    <%# query will be based on the original facet, the first part %>
    <%# api response will use the aggregation name, the second part %>
    <% original_facet = facet_name %>
    <% if info["aggregation_name"] %>
      <% facet_name = info["aggregation_name"] %>
    <% end %>
    <% if should_display?(facets[facet_name], info) %>
      <% facet_res = facets[facet_name] %>
      <% data_safe_name = facet_name.parameterize  %>
      <% fparams = pull_out_fparams %>
      <% start_open = fparams.include?(original_facet) %>
      <% class_in =  start_open ? "in" : "" %>
      <% class_glyphicon = start_open ? "glyphicon-chevron-down" : "glyphicon-chevron-right" %>

      <div class="panel panel-default panel-filter panel-filter-<%= info['label'].parameterize %>">

        <%# panel heading %>
        <a
          aria-label="<%= t("search.filters.show", label: info['label'], default: "Show #{info['label']} Filters") %>"
          class="panel-heading-link"
          data-toggle="collapse"
          href="#fc-<%= data_safe_name %>"
          role="button">
          <div class="clearfix panel-heading">
            <h3 class="pull-left panel-title">
              <%= info["label"] %>
            </h3>
            <span class="pull-right glyphicon <%= class_glyphicon %>" aria-hidden="true"></span>
          </div>
        </a>

        <%# panel body %>
        <%# if requested parameter, then do not collapse facet %>
        <div class="panel-body collapse <%= class_in %>" id="fc-<%= data_safe_name %>">
          <ul class="list-unstyled">
            <% facet_res.each do |key, value| %>
              <%# NOTE the below line accommodates Apium v1.0 as well as
                  v1.1 when facet responses included more information %>
              <% key, label, num = format_facet_response(key, value) %>
              <% selected = facet_selected?(original_facet, key) %>

              <% text = create_label(
                facet_label(
                  type: facet_name,
                  normalized: key,
                  label: label
                ),
                t("search.filters.no_label")
              ) %>

              <%# list item %>
              <% if !selected %>
                <li>
                  <%= link_to sanitize(text), prefix_path(route_path,
                    facet_link(facet_name, key, false, original_facet)), rel: "nofollow" %>
                  <span class="badge"><%= num %></span>
                </li>
              <% else %>
                <li class="selected">
                  <span><%= sanitize(text) %></span>
                  <span class="badge"><%= num %></span>
                  <%= link_to prefix_path(route_path,
                    remove_facet(original_facet, key)), rel: "nofollow" do %>
                    <button class="btn btn-default btn-xs"
                            title="<%= t("search.filters.clear", label: info['label'], default: "Clear #{info['label']} Filter") %>"
                            aria-label="<%= t("search.filters.clear", label: info['label'], default: "Clear #{info['label']} Filter") %>">
                      <span class="pull-right glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                  <% end %>
                </li>
              <% end %>
            <% end %>
          </ul>
          <% if facet_res.count >= @facet_limit %>
            <%= link_to t("search.filters.see_more", default: "See more"),
              prefix_path("browse_facet_path",
              facet: original_facet.parameterize(separator: ".")),
              class: "btn btn-info btn-xs", rel: "nofollow", role: "button" %>
          <% end %>
        </div> <!-- /panel-body -->

      </div> <%# /panel panel-default %>
    <% end %>
  <% end %>
<% end %>
